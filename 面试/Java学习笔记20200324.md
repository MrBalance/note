# Java学习笔记

## JVM

### 基本概念

jdk：Java development kit

jre：java runtime environment

 jvm：java virtual machine

jdk主要是java编译（将.java文件编译成.class文件），以及java环境运行的检测工具

如：jvisualvm

一种图形化工具，可在Java虚拟机中运行时提供有关基于Java技术的应用程序（Java应用程序）的详细信息。 Java VisualVM提供内存和CPU分析，堆转储分析，内存泄漏检测，MBean访问和垃圾收集。

jre主要是Java运行时所需要的环境，其中就包括jvm

jvm使得java这种语言具有可移植性，也就是常常说的once write run every where,即在任意环境编译出的jar包可以在任意装有对应jvm的系统中运行

同时java语言还具有内存自动分配管理的功能，这使得开发人员在实际开发中不用过多的关注内存分配问题，而将更多的精力放到实际开发中去。这也是java语言能够收大多数开发着欢迎而流行起来的原因

### JVM的构成

| 数据   | 指令       |
| ------ | ---------- |
| 方法区 | 程序计数器 |
| heap   | jvm栈      |
|        | 本地方法栈 |

1. 程序计数器
   程序计数器记录了当前线程正在执行字节码指令的地址和行号
   场景：

   - 当正在执行的线程因为一些因素而被抢占时，线程中的程序计数器会记录下线程执行字节码指令所在的位置，当线程再次被唤醒时能够从记录的运行位置继续运行下去
   - 当正在执行的线程因为其他控制指令（if，switch，break等）控制而改变执行位置的时候，记录下运行到的位置，当控制指令执行完后，再根据记录的指令继续执行下去

   程序计数器属于线程独享资源，每个线程都有自己的程序计数器

2. jvm栈
   jvm栈的总空间是固定的，其中一个每个单位空间成为栈帧，而栈帧又包括：

   1. 局部变量表：存放局部变量的信息，只有程序执行时才有数据，其空间大小受变量个数影响，但是在编译时空间大小就确定下来了。==大小为32位，float、int、short、byte类型就直接存储，long、double类型的变量占两个空间，对象变量存储对象的引用==
   
   2. 操作数栈：字节码指令的工作空间，根据last-in-frist-out原则，按照指令顺序，操作每个字节码指令的进栈和出栈。
   
   3. 动态链接：字节码中方法调用的符号引用，在程序运行时转化为直接引用
   
      ```java
      @Autoware
      private Service service; //Service为接口
      serviceImpl_1;//Service的第一个实现类
      serviceImpl_2;//Service的第二个实现类
      
      service.do();//在实际运行中Service作为接口无法直接使用其中的do方法，实际调用的是其实现类的引用方法，这个过程叫做动态链接
      ```
   
   4. 出口：方法正常（return）和异常（Exception）运行结束后回到的位置
   
   5. ...
   
   每个栈帧的空间大小是不确定的，所以整个栈的深度是不确定的
   
3. 本地方法栈
   本地方法栈和jvm栈类似，不过其中主要存放的是本地方法信息（native）

5. 堆
   运行时数据区，是线程共享的内存，因为对象和数组都存储于此，因此也是垃圾回收最重要的区域，在GC回收中采用分代回收算法，而堆在GC回收中主要是属于新生代和老年代
   
5. 方法区
   方法区主要存放类信息、常量、静态变量、just in time 等信息，也是在GC回收中属于永久代（jdk1.8以前），hotspot把垃圾分代扩充至方法区，用java堆的永久代去实现方法区，这样就不用单独的开发方法区的内存管理器，而永久代主要是针对常量池和类型卸载，因此这部分收益很小。

   运行时常量池也是方法区的一部分，其中除了类的本版、字段、方法、接口等信息以外还有常量池。

   而常量池主要是存放运行时的==字面量==和==符号引用==

### JVM运行时内存

从GC的角度来看JVM的运行时内存分为新生代（1/3）和老年代（2/3）
新生代用来存放新生对象占据1/3空间，由于其要频繁创建对象，所以会频繁触发minorGC，又将其分为eden、SurvivorFrom、SurvivorTo三个区域

eden：占8/10
from survivor（S1）：占1/10
to survivor（S2）：占1/10